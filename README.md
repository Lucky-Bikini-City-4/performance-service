# 🎭 Performance Service

공연 서비스는 통합 예약 시스템 다예약의 핵심 마이크로서비스로, 공연 정보 관리 및 예약 현황을 담당합니다. Kafka를 활용한 이벤트 기반 아키텍처를 통해 예약 서비스와 비동기적으로 통신하며, 실시간으로 좌석 상태와 잔여 좌석 수를 업데이트합니다.

## ✨ 주요 기능

### 🎵 공연 관리
- **공연 생성 및 관리**: 출연진, 공연장 정보와 연동하여 공연 관리
- **공연 정보 조회**: 타입별/지역별 조회 및 페이지네이션 지원
- **공연 활성화 관리**: 공연의 판매 상태를 실시간으로 제어
- **티켓 판매 기간 설정**: 티켓 오픈/마감 시간 자동 관리

### 🎤 출연진 관리
- **출연진 정보 등록**: 배우, 가수 등 출연진 프로필 관리
- **공연별 출연진 연결**: 출연진과 공연 간 관계 설정
- **출연진 목록 조회**: 페이지네이션 지원

### 🏛️ 공연장 관리
- **공연장 등록 및 수정**: 지역별 공연장 정보 관리
- **구역 관리**: 공연장 내 구역별 좌석 수 설정
- **수용 인원 관리**: 공연장 총 수용 인원 정보

### 📅 공연 회차 관리
- **회차 생성**: 공연 날짜 및 시간별 회차 설정
- **구역별 가격 책정**: 회차 생성 시 구역별 티켓 가격 설정
- **회차 일정 수정**: 공연 스케줄 변경 가능 (티켓오픈 이후 수정 불가)

### 💺 좌석 관리
- **실시간 좌석 상태 조회**: 구역별 잔여 좌석 수 확인
- **좌석별 예약 상태 관리**: 개별 좌석의 품절 여부 추적
- **좌석 상태 변경**: 예약 완료 시 자동 품절 처리

### 🔄 이벤트 기반 처리
- **예약 완료 이벤트 수신**: Kafka를 통한 예약 서비스와의 비동기 통신
- **좌석 상태 자동 업데이트**: 예약 완료 시 좌석 품절 상태 반영
- **잔여 좌석 수 실시간 동기화**: 구역별 남은 좌석 수 자동 계산

## 📝 API 명세

API 상세 문서는 Swagger UI에서 확인할 수 있습니다.

[`http://13.209.64.112:10500/swagger-ui/swagger-ui/index.html`](http://13.209.64.112:10500/swagger-ui/swagger-ui/index.html)

Swagger UI 접속 불가 시 아래의 Google Docs로 확인할 수 있습니다.

[`https://docs.google.com/spreadsheets/d/1erfJV-eh3TtUMcaTJLLNou-vhwnxBvB4MV5cJ72-hw8`](https://docs.google.com/spreadsheets/d/1erfJV-eh3TtUMcaTJLLNou-vhwnxBvB4MV5cJ72-hw8)

## 🛠️ 기술적 의사결정

### Apache Kafka를 활용한 비동기 통신 설계

#### 요구 사항
- 예약 서비스에서 공연 예매가 완료되면 공연 서비스의 좌석 상태 및 잔여 좌석 수를 업데이트해야 함
- 메시지 큐 기반 비동기 방식으로 구현하여 동시성 문제를 최소화하고, 서비스 간 느슨한 결합을 유지해야 함

#### 비교 분석

| 기술 | 장점 | 단점 |
|------|------|------|
| **Apache Kafka** ✅ | • 높은 처리량 및 내구성<br>• 이벤트 영속성 보장 | • 설정과 운영이 복잡함 |
| RabbitMQ | • 설정이 간단하고 다양한 라우팅 패턴 지원<br>• 빠른 메시지 전달 | • 대규모 동시 요청 처리에 한계 |
| AWS SQS | • 완전 관리형 서비스로 운영 부담 최소화<br>• AWS 생태계와의 통합 용이 | • 대규모 동시 요청 시 지연 가능<br>• FIFO 큐 사용 시 비용 증가 |

#### 결정 및 근거

- **높은 처리량**: 분산 로그 시스템 구조와 순차 디스크 쓰기 방식을 통해 기존 메시지 큐 시스템보다 높은 처리량을 제공함
- **데이터 내구성**: 모든 예매 완료 이벤트는 Kafka 브로커의 디스크에 로그 형태로 저장되므로 시스템 장애가 발생하더라도 데이터 손실 없이 모든 이벤트를 안전하게 복구할 수 있음
- **확장성**: 향후 새로운 기능 추가 시 기존 시스템 변경 없이 새로운 컨슈머만 추가하여 동일한 이벤트 데이터를 활용할 수 있음
- **이벤트 소싱 지원**: 모든 좌석 상태 변경 이력을 이벤트로 추적 가능하여 디버깅 및 감사 용이

## 🔫 트러블슈팅

### Fat JAR 선택 로직 개선으로 EC2 배포 문제 해결

#### 문제 정의
- CI/CD 배포 파이프라인은 성공했지만, EC2 서버에서 정상적으로 실행되지 않음
- EC2 서버에 접속해서 확인한 결과, 배포에 사용된 JAR 파일이 **Plain JAR**이었음
- Spring Boot Application을 독립적으로 실행하려면, 모든 종속성을 포함한 **Fat JAR** 필요

#### 원인 분석

**1. JAR 파일 선택 로직 문제**
- 기존 배포 스크립트는 `build/libs/performance-service-build.jar`만 하드코딩으로 선택
- 프로젝트 빌드 환경에 따라 Fat JAR가 아닌 Plain JAR가 선택될 수 있음

**2. JAR 검증 로직 부재**
- JAR 선택 시 파일 크기 및 Fat JAR 여부 검증 로직이 없음
- 배포 파이프라인 성공과 실제 실행 상태 불일치 발생

#### 해결 방안 및 결과

**개선된 JAR 선택 로직 적용**

- build/libs/ 디렉토리 내 모든 JAR 파일 확인
- Fat JAR 우선 선택 (plain, gradle-wrapper 제외 및 파일 크기 > 1MB)
- 선택된 JAR가 조건을 만족하지 않으면 배포 중단

**적용 결과**
- 올바른 Fat JAR가 선택되어 EC2 서버의 애플리케이션이 정상 실행됨
- 배포 파이프라인 성공과 실제 실행 상태 불일치 문제 해결
- 배포 안정성 향상 및 배포 실패 조기 감지 가능
